<%init>
use Data::Dumper;
use Lingua::EN::Sentence qw( get_sentences );
#Lingua::EN::Sentence::set_locale("en_US.ISO8859-1");
use Encode qw(is_utf8 _utf8_on);
my $ref = $c->stash->{records};
my $auth_is_saved;

if ( $c->user ) {
    my $auth_rs = $c->user->my_authors;
    while ( my $auth = $auth_rs->next ) {
        my $name = $auth->authors->first_name . " " . $auth->authors->last_name;
        my $st = $c->stash->{search_term};
        $auth_is_saved = 1 if lc $st eq lc $name ;
    }
}

</%init>

<% $c->stash->{error_msg} %>

<h2>Results for "<% $c->stash->{search_term} %>"</h2>

% unless ( $auth_is_saved ) {
<!-- Show "save to list" -->
<a id="save_author" href="#">Save <b><% $c->stash->{search_term} %></b> to your favorites</a>

<script type="text/javascript">
$("#save_author").click(function(){
  $(this).load('<% $c->uri_for("/user/save_author") %>', { value: "<% $c->stash->{search_term} %>" }, function() { $("#my_authors").load('<% $c->uri_for("/user/list_authors") %>') });
});
</script>

% } 

% unless ( $c->user ) {
Login to Save <b><% $c->stash->{search_term} %></b> to your favorites.
% }

<div id="author_results">
% foreach my $rec ( keys %{$ref} ) {
% my $er = $ref->{$rec}->{editorialreview};
% _utf8_on($er);
% warn "before get_sentences...";
% my $sentences = get_sentences($er);
% warn "after get_sentences...";
% my $first = shift @$sentences;

    <div id="details_<% $rec %>" style="height:auto;">

    <h2><% $ref->{$rec}->{title} %></h2> by <h3><% $ref->{$rec}->{author} %></h3><br clear="all"/>

    <img src="<% $ref->{$rec}->{smallimage} %>" height="<% $ref->{$rec}->{smallimageheight} %>" width="<% $ref->{$rec}->{smallimagewidth} %>" />

    <div style="margin-left:75px;">

    <p id="er_first_<% $rec %>">
    <% $first %> 
    <a id="more_<% $rec %>" href="#more_<% $rec %>">More...</a>

    </p>

    <p id="er_<% $rec %>" style="display: none;">
% foreach my $s ( @$sentences ) {
    <% $s %>
% }
    </p>

    </div>

    <script type="text/javascript">
    $("#more_<% $rec %>").click(function(){ $("#er_<% $rec %>").slideToggle("normal", function(){ $(this).height("auto"); }); });
    </script>
    <br clear="all"/>
    <br clear="all"/>

    <div style="float:right;">
    Publish Date: <% $ref->{$rec}->{pubdate} %>
    Newest Low Price: <% $ref->{$rec}->{formattedprice} %>
    <a href="<% $ref->{$rec}->{detailpageurl} %>">View Details</a>
    </div>

    </div>
<br clear="all"/>
% }

</div>

<%doc>
<%flags>
inherit => undef
</%flags>
</%doc>
