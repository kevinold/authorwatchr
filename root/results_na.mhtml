<%init>
use AwUtil;
use Data::Dumper;
my $response = $c->stash->{records};
my $auth_is_saved;
my $term = $c->stash->{search_term};
my $norm_term = AwUtil::normalize($term);

if ( $c->user ) {
    my $auth_rs = $c->user->my_authors;
    while ( my $auth = $auth_rs->next ) {
        my $name = $auth->authors->id;
        $c->log->debug("**********norm_term is: $norm_term");
        $auth_is_saved = 1 if lc $norm_term eq lc $name ;
    }
}
</%init>


<h2>Results for "<% $term %>"</h2>

% if ( $c->user ) {

%   unless ( $auth_is_saved ) {
<!-- Show "save to list" -->
<button id="save_author">Save <b><% $term %></b> to your favorites</button>

<script type="text/javascript">
/*$("#save_author")
    .click( function(){
                $(this).load(
                    '<% $c->uri_for("/user/save_author") %>', 
                    { value: "<% $term %>" },
                    function() { $("#my_authors").load('<% $c->uri_for("/user/list_authors") %>') }
                )
            }
    );
*/

$("#save_author")
.click( function(){
    $(this).load('<% $c->uri_for("/user/save_author") %>', 
                 { id: "<% $norm_term %>", value: "<% $term %>" },
                 aw.loadMyAuthors
    ).remove();
});

</script>

% } # end unless auth_is_saved
% } else {
Login to Save <b><% $term %></b> to your favorites.
% }



% if ($response) {

<div id="author_results">
%   for my $prop ($response->properties) {
%       next if $prop->year() < 2008;   # Change this line to be greater than today
%       my $norm_author = AwUtil::normalize($prop->author());
%       next unless $norm_author eq $norm_term;

    <div class="result" class="clearfix">

    <h2><% $prop->ProductName() %> by <span><% $prop->author() %></span></h2>

    <img src="<% $prop->ImageUrlSmall() %>" />


    <p> <% $prop->ProductDescription() %> </p>

    <br clear="all"/>
    <br clear="all"/>
    <br clear="all"/>
    <% $prop->{xmlref}->{OfferSummary}->{LowestNewPrice}->{FormattedPrice} %>
    Release Date: <b><% $prop->ReleaseDate() %> <% $prop->year() %></b>
    Newest Low Price: <% $prop->OurPrice() || $prop->ListPrice() %>
    <a href="<% $prop->DetailPageURL() %>">View Details</a>

        <!-- <% $prop->as_string() %>  <% $prop->similar_asins() %> -->
        <br/>
        <br/>
    </div>
<br clear="all"/>
%   } 

</div> <!-- end author_results -->

% }
